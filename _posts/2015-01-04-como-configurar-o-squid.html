---
layout: post
title: Como configurar o Squid
date: '2015-01-04T12:56:00.001-08:00'
author: Marcos Oliveira
tags:
- Linux
- Servidores
- GNU
- Redes
modified_time: '2015-01-04T12:56:12.503-08:00'
thumbnail: http://4.bp.blogspot.com/-PY7EliHW6-s/VKmo1ZJ2sVI/AAAAAAAABIY/IW_frwfJa2E/s72-c/squid.png
blogger_id: tag:blogger.com,1999:blog-2422865715758349944.post-5955019099801520742
blogger_orig_url: http://www.terminalroot.com.br/2015/01/como-configurar-o-squid.html
---

<div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-PY7EliHW6-s/VKmo1ZJ2sVI/AAAAAAAABIY/IW_frwfJa2E/s1600/squid.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-PY7EliHW6-s/VKmo1ZJ2sVI/AAAAAAAABIY/IW_frwfJa2E/s320/squid.png" /></a></div><b>O <span style="color: blue;">Squid</span> é um servidor proxy que suporta HTTP, HTTPS, FTP e outros. Ele reduz a utilização da conexão e melhora os tempos de resposta fazendo cache de requisições freqüentes de páginas web numa rede de computadores. Ele pode também ser usado como um proxy reverso.</b><br /><span style="font-size: large;"><b><br /></b></span><span style="font-size: large;"><b>Instalação</b></span><br /><b><br /></b><b>Para instalar o Squid no Debian e Debians-Like (Ubuntu, Linux Mint...):</b><br /><b>{% highlight bash %}# su<br /># apt-get install squid3{% endhighlight %}</b><br /><b><br /></b><b>O Arquivo de configuração do Squid:</b><br /><b>{% highlight bash %}# vi /etc/squid3/squid.conf{% endhighlight %}, no arquivo que se abrirá, apague tudo (pode fazer um backup do arquivo antes) e inclua o seguinte código:</b><br /><b>{% highlight bash %}http_port 3128<br />visible_hostname marcospinguim<br />cache_mgr marcospinguim@linuxmail.org<br />error_directory /usr/share/squid3/errors/Portuguese{% endhighlight %}</b><br /><b><br /></b><b>http_port: DETERMINA A PORTA QUE SERÁ USADA PELO SERVIDOR.</b><br /><b>visible_hostname: DEFINA O NOME DE EXIBIÇÃO DO SERVIDOR.</b><br /><b>cache_mgr: DEFINA O E-MAIL DO ADMINISTRADOR PARA RECEBER MENSAGEM EM CASOS GRAVES.</b><br /><b>error_directory: DEFINA O IDIOMA DAS PÁGINAS DE MENSAGEM DE ERROS EM PORTUGUÊS.</b><br /><b><br /></b><span style="font-size: large;"><b>Cache</b></span><br /><b><br /></b><b>No cache são armazenados os objetos da Internet (ex. dados de páginas web) disponíveis via protocolo HTTP, FTP e Gopher num sistema mais próximo ao do cliente. Os navegadores podem então usar o Squid local como um servidor Proxy HTTP, reduzindo o tempo de acesso aos objetos e reduzindo a utilização da conexão.</b><br /><b><br /></b><b>Para configurar o cache no Squid, adicione as seguintes configurações:</b><br /><b>{% highlight bash %}hierarchy_stoplist cgi-bin ?<br />cache_mem 64 MB<br />maximum_object_size_in_memory 128 KB<br />maximum_object_size 200 MB<br />cache_dir ufs /var/spool/squid3 4096 16 256{% endhighlight %}</b><br /><b><br /></b><b>hierarchy_stoplist: DEFINA PALAVRAS QUE SE FOR ENCONTRADAS NA URL, A PÁGINA IRÁ SER CARREGADA DIRETO DO CACHE.</b><br /><b>cache_mem: DEFINA A QUANTIDADE DE MEMÓRIA QUE O SERVIDOR IRÁ USAR PARA O CACHE.</b><br /><b>maximum_object_size_in_memory: DEFINA O TAMANHO MÁXIMO DO OBJETO QUE PODERÁ SER ARMAZENADO NA MEMÓRIA, SENÃO SERÁ ARMAZENADO NO DISCO RÍGIDO.</b><br /><b>maximum_object_size: DEFINA O TAMANHO MÁXIMO DO OBJETO QUE PODERÁ SER ARMAZENADO NO DISCO RÍGIDO, SENÃO SERÁ DESCARTADO O OBJETO.</b><br /><b>cache_dir ufs /var/spool/squid3 4096 32 512: O DIRETÓRIO DO CACHE, AONDE SERÁ ARMAZENADO OS OBJETOS E ATRIBUIR 4GB DE ESPAÇO DE ARMAZENAMENTO NO CACHE.</b><br /><b><br /></b><b>Definindo o tempo de vida dos objetos, para o Squid saber se deve atualizar ou não.</b><br /><b><br /></b><b>{% highlight bash %}refresh_pattern ^ftp:    360 20% 10080<br />refresh_pattern -i (/cgi-bin/|\?) 0 0% 0<br />refresh_pattern .    0 20% 4320{% endhighlight %}</b><br /><b><br /></b><b>1ª coluna: defina o tempo em minutos, em cada acesso, quando deve verificar se houve modificação no objeto.</b><br /><b>2ª coluna: defina a porcentagem mínima da modificação do objeto que deve ter para ser atualizado.</b><br /><b>3ª coluna: defina o tempo em minutos, quando deve efetuar uma atualização mesmo não ter sido modificado.</b><br /><b><br /></b><b>Insira essa configiração abaixo também no arquivo para especificar o caminho do LOG de acesso e do Cache:</b><br /><b>{% highlight bash %}access_log /var/log/squid3/access.log<br />cache_log /var/log/squid3/cache.log{% endhighlight %}</b><br /><b><br /></b><span style="font-size: large;"><b>Controle de Acesso</b></span><br /><b><br /></b><b>A ACL ou Lista de Controle de Acesso, é onde define aonde pode acessar ou não pela Internet. Uma coisa importante que deve saber é que o Squid interpreta as ACL's de cima para baixo, então deve ficar atento quando for criar as regras.</b><br /><b><br /></b><b>Crie duas acl com o tipo src (IP de origem) e adicione o IP do servidor e o IP da rede:</b><br /><b><br /></b><b>{% highlight bash %}acl localhost src 127.0.0.1/32<br />acl intranet src 192.168.1.1/24{% endhighlight %}</b><br /><b><br /></b><b>Crie uma acl com o tipo proto (protocolo) e adicione o protocolo "cache_object":</b><br /><b><br /></b><b>{% highlight bash %}acl manager proto cache_object{% endhighlight %}</b><br /><b><br /></b><b>O protocolo "cache_object" é usado para obter informações sobre o estado do Squid.</b><br /><b><br /></b><b>É recomendável que permita apenas o servidor obter as informações do Squid, então adicione a seguinte regra:</b><br /><b><br /></b><b>{% highlight bash %}http_access allow manager localhost<br />http_access deny manager{% endhighlight %}</b><br /><b><br /></b><b>Crie uma acl do tipo method (método de requisição) e adicione o método PURGE:</b><br /><b><br /></b><b>{% highlight bash %}acl purge method PURGE{% endhighlight %}</b><br /><b><br /></b><b>O método de requisição PURGE serve para limpar/excluir objetos armazenados no cache.</b><br /><b><br /></b><b>Para permitir que apenas o servidor possa exclua objetos, adicione a seguinte regra:</b><br /><b><br /></b><b>{% highlight bash %}http_access allow purge localhost<br />http_access deny purge{% endhighlight %}</b><br /><b><br /></b><b>Crie uma acl do tipo port (porta) e adicione as portas que serão liberadas:</b><br /><b><br /></b><b>{% highlight bash %}acl Safe_ports port 21 70 80 210 280 443 488 563 591 631 777 873 901 1025-65535{% endhighlight %}</b><br /><b><br /></b><b>Se quiser deixar mais organizado, ou seja, adicionar uma porta de cada vez para poder comentar em cada linha a descrição do protocolo da porta que está sendo liberada, também pode deixando assim:</b><br /><b><br /></b><b>{% highlight bash %}acl Safe_ports port 21    # ftp<br />acl Safe_ports port 70    # gopher<br />acl Safe_ports port 80    # http<br />acl Safe_ports port 210   # wais<br />acl Safe_ports port 280   # http-mgmt<br />acl Safe_ports port 443   # https<br />acl Safe_ports port 488   # gss-http<br />acl Safe_ports port 563   # nntps<br />acl Safe_ports port 591   # filemaker<br />acl Safe_ports port 631   # cups<br />acl Safe_ports port 777   # multiling http<br />acl Safe_ports port 873   # rsync<br />acl Safe_ports port 901   # swat<br />acl Safe_ports port 1025-65535   # unregistered ports{% endhighlight %}</b><br /><b><br /></b><b>Para bloquear o acesso em portas que não foram liberadas, adicione a seguinte regra:</b><br /><b><br /></b><b>{% highlight bash %}http_access deny !Safe_ports{% endhighlight %}</b><br /><b><br /></b><b>Crie uma acl do tipo dstdomain (domínio de destino) e adicione um dóminio iniciando com o ponto:</b><br /><b><br /></b><b>{% highlight bash %}acl domains dstdomain .twitter.com{% endhighlight %}</b><br /><b><br /></b><b>Se no caso for vários domínios de destino, define o caminho do arquivo que será adicionado os domínios:</b><br /><b><br /></b><b>{% highlight bash %}acl domains dstdomain "/etc/squid/domains"{% endhighlight %}</b><br /><b><br /></b><b>Crie o arquivo que foi definido na acl e adicione os domínios de destino:</b><br /><b><br /></b><b>{% highlight bash %}.orkut.com<br />.google.com<br />.youtube.com{% endhighlight %}</b><br /><b><br /></b><b>Para bloquear o acesso nos domínios de destino, adicione a seguinte regra:</b><br /><b><br /></b><b>{% highlight bash %}http_access deny domains{% endhighlight %}</b><br /><b><br /></b><b>Crie uma acl do tipo url_regex (expressão regular na url) e adicione uma expressão regular:</b><br /><b><br /></b><b>{% highlight bash %}acl words url_regex orkut{% endhighlight %}</b><br /><b><br /></b><b>A acl do tipo url_regex percorre url em busca de expressões regulares. A acl é case-sensitive, se no caso estiver procurando a expressão "jogo" e tiver "Jogo", serão consideradas diferentes.</b><br /><b><br /></b><b>Para adicionar várias expressões, define o caminho do arquivo que será adicionado as expressões. E use a opção "-i" para tornar a acl em case-insensitive:</b><br /><b><br /></b><b>{% highlight bash %}acl words url_regex -i "/etc/squid/words"{% endhighlight %}</b><br /><b><br /></b><b>Crie o arquivo que foi definido na acl e adicione as expressões regulares:</b><br /><b><br /></b><b>{% highlight bash %}microsoft<br />google<br />orkut<br />windows{% endhighlight %}</b><br /><b><br /></b><b>Para bloquear o acesso em urls com as expressões regulares, adicione a seguinte regra:</b><br /><b><br /></b><b>{% highlight bash %}http_access deny words{% endhighlight %}</b><br /><b><br /></b><b>Criar uma acl do tipo urlpath_regex (expressão regulares no caminho da url) e define o caminho do arquivo que será adicionado as expressões regulares:</b><br /><b><br /></b><b>{% highlight bash %}acl extensions urlpath_regex -i "/etc/squid/extensions"{% endhighlight %}</b><br /><b><br /></b><b>A acl do tipo urlpath_regex é semelhante a url_regex, só que é ignorado o domínio e protocolo. Por exemplo, essa url "http://www.invasao.com.br/site/index.php", irá fazer a busca da expressão regular apenas nessa parte "/site/index.php":</b><br /><b><br /></b><b>Para bloquear o acesso em urls path com expressões regulares, adicione a seguinte regra:</b><br /><b><br /></b><b>{% highlight bash %}http_access deny extensions{% endhighlight %}</b><br /><b><br /></b><b>Sem mais acl para criar, adicione a seguinte regra para permitir que apenas as máquinas da rede e o servidor sejam liberados para acessar a Internet:</b><br /><b><br /></b><b>{% highlight bash %}http_access allow intranet<br />http_access allow localhost<br />http_access deny all{% endhighlight %}</b><br /><b><br /></b><b><br /></b><b>Após ter terminado as configurações, recarregue as configurações no Squid:</b><br /><b>{% highlight bash %}# /etc/init.d/squid3 reload{% endhighlight %}</b><br /><b><br /></b><br /><div style="color: #666666;"><i><span style="font-size: x-small;"><b>Fontes:</b></span></i></div><div style="color: #666666;"><i><span style="font-size: x-small;"><b>http://pt.wikipedia.org/</b></span></i></div><div style="color: #666666;"><i><span style="font-size: x-small;"><b>http://www.hardware.com.br/</b></span></i></div><div style="color: #666666;"><i><span style="font-size: x-small;"><b>http://blog.cesar.augustus.nom.br/</b></span></i></div>