---
layout: post
title: Como configurar o Squid
date: '2015-01-04T12:56:00.001-08:00'
description: Como configurar o Squid
main-class: 'linux'
color: '#3b5998'
author: Marcos Oliveira
tags:
- Linux
- Servidores
- GNU
- Redes
modified_time: '2015-01-04T12:56:12.503-08:00'
thumbnail: http://4.bp.blogspot.com/-PY7EliHW6-s/VKmo1ZJ2sVI/AAAAAAAABIY/IW_frwfJa2E/s72-c/squid.png
twitter_text: Como configurar o Squid
introduction: Como configurar o Squid
---

<p>
<div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-PY7EliHW6-s/VKmo1ZJ2sVI/AAAAAAAABIY/IW_frwfJa2E/s1600/squid.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-PY7EliHW6-s/VKmo1ZJ2sVI/AAAAAAAABIY/IW_frwfJa2E/s320/squid.png" /></a></div><b>O <span style="color: blue;">Squid</span> é um servidor proxy que suporta HTTP, HTTPS, FTP e outros. Ele reduz a utilização da conexão e melhora os tempos de resposta fazendo cache de requisições freqüentes de páginas web numa rede de computadores. Ele pode também ser usado como um proxy reverso.</b></p><p><span style="font-size: large;"><b></p><p></b></span><span style="font-size: large;"><b>Instalação</b></span></p><p><b></p><p></b><b>Para instalar o Squid no Debian e Debians-Like (Ubuntu, Linux Mint...):</b></p><p><b>{% highlight bash %}# su</p><p># apt-get install squid3{% endhighlight %}</b></p><p><b></p><p></b><b>O Arquivo de configuração do Squid:</b></p><p><b>{% highlight bash %}# vi /etc/squid3/squid.conf{% endhighlight %}, no arquivo que se abrirá, apague tudo (pode fazer um backup do arquivo antes) e inclua o seguinte código:</b></p><p><b>{% highlight bash %}http_port 3128</p><p>visible_hostname marcospinguim</p><p>cache_mgr marcospinguim@linuxmail.org</p><p>error_directory /usr/share/squid3/errors/Portuguese{% endhighlight %}</b></p><p><b></p><p></b><b>http_port: DETERMINA A PORTA QUE SERÁ USADA PELO SERVIDOR.</b></p><p><b>visible_hostname: DEFINA O NOME DE EXIBIÇÃO DO SERVIDOR.</b></p><p><b>cache_mgr: DEFINA O E-MAIL DO ADMINISTRADOR PARA RECEBER MENSAGEM EM CASOS GRAVES.</b></p><p><b>error_directory: DEFINA O IDIOMA DAS PÁGINAS DE MENSAGEM DE ERROS EM PORTUGUÊS.</b></p><p><b></p><p></b><span style="font-size: large;"><b>Cache</b></span></p><p><b></p><p></b><b>No cache são armazenados os objetos da Internet (ex. dados de páginas web) disponíveis via protocolo HTTP, FTP e Gopher num sistema mais próximo ao do cliente. Os navegadores podem então usar o Squid local como um servidor Proxy HTTP, reduzindo o tempo de acesso aos objetos e reduzindo a utilização da conexão.</b></p><p><b></p><p></b><b>Para configurar o cache no Squid, adicione as seguintes configurações:</b></p><p><b>{% highlight bash %}hierarchy_stoplist cgi-bin ?</p><p>cache_mem 64 MB</p><p>maximum_object_size_in_memory 128 KB</p><p>maximum_object_size 200 MB</p><p>cache_dir ufs /var/spool/squid3 4096 16 256{% endhighlight %}</b></p><p><b></p><p></b><b>hierarchy_stoplist: DEFINA PALAVRAS QUE SE FOR ENCONTRADAS NA URL, A PÁGINA IRÁ SER CARREGADA DIRETO DO CACHE.</b></p><p><b>cache_mem: DEFINA A QUANTIDADE DE MEMÓRIA QUE O SERVIDOR IRÁ USAR PARA O CACHE.</b></p><p><b>maximum_object_size_in_memory: DEFINA O TAMANHO MÁXIMO DO OBJETO QUE PODERÁ SER ARMAZENADO NA MEMÓRIA, SENÃO SERÁ ARMAZENADO NO DISCO RÍGIDO.</b></p><p><b>maximum_object_size: DEFINA O TAMANHO MÁXIMO DO OBJETO QUE PODERÁ SER ARMAZENADO NO DISCO RÍGIDO, SENÃO SERÁ DESCARTADO O OBJETO.</b></p><p><b>cache_dir ufs /var/spool/squid3 4096 32 512: O DIRETÓRIO DO CACHE, AONDE SERÁ ARMAZENADO OS OBJETOS E ATRIBUIR 4GB DE ESPAÇO DE ARMAZENAMENTO NO CACHE.</b></p><p><b></p><p></b><b>Definindo o tempo de vida dos objetos, para o Squid saber se deve atualizar ou não.</b></p><p><b></p><p></b><b>{% highlight bash %}refresh_pattern ^ftp:    360 20% 10080</p><p>refresh_pattern -i (/cgi-bin/|\?) 0 0% 0</p><p>refresh_pattern .    0 20% 4320{% endhighlight %}</b></p><p><b></p><p></b><b>1ª coluna: defina o tempo em minutos, em cada acesso, quando deve verificar se houve modificação no objeto.</b></p><p><b>2ª coluna: defina a porcentagem mínima da modificação do objeto que deve ter para ser atualizado.</b></p><p><b>3ª coluna: defina o tempo em minutos, quando deve efetuar uma atualização mesmo não ter sido modificado.</b></p><p><b></p><p></b><b>Insira essa configiração abaixo também no arquivo para especificar o caminho do LOG de acesso e do Cache:</b></p><p><b>{% highlight bash %}access_log /var/log/squid3/access.log</p><p>cache_log /var/log/squid3/cache.log{% endhighlight %}</b></p><p><b></p><p></b><span style="font-size: large;"><b>Controle de Acesso</b></span></p><p><b></p><p></b><b>A ACL ou Lista de Controle de Acesso, é onde define aonde pode acessar ou não pela Internet. Uma coisa importante que deve saber é que o Squid interpreta as ACL's de cima para baixo, então deve ficar atento quando for criar as regras.</b></p><p><b></p><p></b><b>Crie duas acl com o tipo src (IP de origem) e adicione o IP do servidor e o IP da rede:</b></p><p><b></p><p></b><b>{% highlight bash %}acl localhost src 127.0.0.1/32</p><p>acl intranet src 192.168.1.1/24{% endhighlight %}</b></p><p><b></p><p></b><b>Crie uma acl com o tipo proto (protocolo) e adicione o protocolo "cache_object":</b></p><p><b></p><p></b><b>{% highlight bash %}acl manager proto cache_object{% endhighlight %}</b></p><p><b></p><p></b><b>O protocolo "cache_object" é usado para obter informações sobre o estado do Squid.</b></p><p><b></p><p></b><b>É recomendável que permita apenas o servidor obter as informações do Squid, então adicione a seguinte regra:</b></p><p><b></p><p></b><b>{% highlight bash %}http_access allow manager localhost</p><p>http_access deny manager{% endhighlight %}</b></p><p><b></p><p></b><b>Crie uma acl do tipo method (método de requisição) e adicione o método PURGE:</b></p><p><b></p><p></b><b>{% highlight bash %}acl purge method PURGE{% endhighlight %}</b></p><p><b></p><p></b><b>O método de requisição PURGE serve para limpar/excluir objetos armazenados no cache.</b></p><p><b></p><p></b><b>Para permitir que apenas o servidor possa exclua objetos, adicione a seguinte regra:</b></p><p><b></p><p></b><b>{% highlight bash %}http_access allow purge localhost</p><p>http_access deny purge{% endhighlight %}</b></p><p><b></p><p></b><b>Crie uma acl do tipo port (porta) e adicione as portas que serão liberadas:</b></p><p><b></p><p></b><b>{% highlight bash %}acl Safe_ports port 21 70 80 210 280 443 488 563 591 631 777 873 901 1025-65535{% endhighlight %}</b></p><p><b></p><p></b><b>Se quiser deixar mais organizado, ou seja, adicionar uma porta de cada vez para poder comentar em cada linha a descrição do protocolo da porta que está sendo liberada, também pode deixando assim:</b></p><p><b></p><p></b><b>{% highlight bash %}acl Safe_ports port 21    # ftp</p><p>acl Safe_ports port 70    # gopher</p><p>acl Safe_ports port 80    # http</p><p>acl Safe_ports port 210   # wais</p><p>acl Safe_ports port 280   # http-mgmt</p><p>acl Safe_ports port 443   # https</p><p>acl Safe_ports port 488   # gss-http</p><p>acl Safe_ports port 563   # nntps</p><p>acl Safe_ports port 591   # filemaker</p><p>acl Safe_ports port 631   # cups</p><p>acl Safe_ports port 777   # multiling http</p><p>acl Safe_ports port 873   # rsync</p><p>acl Safe_ports port 901   # swat</p><p>acl Safe_ports port 1025-65535   # unregistered ports{% endhighlight %}</b></p><p><b></p><p></b><b>Para bloquear o acesso em portas que não foram liberadas, adicione a seguinte regra:</b></p><p><b></p><p></b><b>{% highlight bash %}http_access deny !Safe_ports{% endhighlight %}</b></p><p><b></p><p></b><b>Crie uma acl do tipo dstdomain (domínio de destino) e adicione um dóminio iniciando com o ponto:</b></p><p><b></p><p></b><b>{% highlight bash %}acl domains dstdomain .twitter.com{% endhighlight %}</b></p><p><b></p><p></b><b>Se no caso for vários domínios de destino, define o caminho do arquivo que será adicionado os domínios:</b></p><p><b></p><p></b><b>{% highlight bash %}acl domains dstdomain "/etc/squid/domains"{% endhighlight %}</b></p><p><b></p><p></b><b>Crie o arquivo que foi definido na acl e adicione os domínios de destino:</b></p><p><b></p><p></b><b>{% highlight bash %}.orkut.com</p><p>.google.com</p><p>.youtube.com{% endhighlight %}</b></p><p><b></p><p></b><b>Para bloquear o acesso nos domínios de destino, adicione a seguinte regra:</b></p><p><b></p><p></b><b>{% highlight bash %}http_access deny domains{% endhighlight %}</b></p><p><b></p><p></b><b>Crie uma acl do tipo url_regex (expressão regular na url) e adicione uma expressão regular:</b></p><p><b></p><p></b><b>{% highlight bash %}acl words url_regex orkut{% endhighlight %}</b></p><p><b></p><p></b><b>A acl do tipo url_regex percorre url em busca de expressões regulares. A acl é case-sensitive, se no caso estiver procurando a expressão "jogo" e tiver "Jogo", serão consideradas diferentes.</b></p><p><b></p><p></b><b>Para adicionar várias expressões, define o caminho do arquivo que será adicionado as expressões. E use a opção "-i" para tornar a acl em case-insensitive:</b></p><p><b></p><p></b><b>{% highlight bash %}acl words url_regex -i "/etc/squid/words"{% endhighlight %}</b></p><p><b></p><p></b><b>Crie o arquivo que foi definido na acl e adicione as expressões regulares:</b></p><p><b></p><p></b><b>{% highlight bash %}microsoft</p><p>google</p><p>orkut</p><p>windows{% endhighlight %}</b></p><p><b></p><p></b><b>Para bloquear o acesso em urls com as expressões regulares, adicione a seguinte regra:</b></p><p><b></p><p></b><b>{% highlight bash %}http_access deny words{% endhighlight %}</b></p><p><b></p><p></b><b>Criar uma acl do tipo urlpath_regex (expressão regulares no caminho da url) e define o caminho do arquivo que será adicionado as expressões regulares:</b></p><p><b></p><p></b><b>{% highlight bash %}acl extensions urlpath_regex -i "/etc/squid/extensions"{% endhighlight %}</b></p><p><b></p><p></b><b>A acl do tipo urlpath_regex é semelhante a url_regex, só que é ignorado o domínio e protocolo. Por exemplo, essa url "http://www.invasao.com.br/site/index.php", irá fazer a busca da expressão regular apenas nessa parte "/site/index.php":</b></p><p><b></p><p></b><b>Para bloquear o acesso em urls path com expressões regulares, adicione a seguinte regra:</b></p><p><b></p><p></b><b>{% highlight bash %}http_access deny extensions{% endhighlight %}</b></p><p><b></p><p></b><b>Sem mais acl para criar, adicione a seguinte regra para permitir que apenas as máquinas da rede e o servidor sejam liberados para acessar a Internet:</b></p><p><b></p><p></b><b>{% highlight bash %}http_access allow intranet</p><p>http_access allow localhost</p><p>http_access deny all{% endhighlight %}</b></p><p><b></p><p></b><b></p><p></b><b>Após ter terminado as configurações, recarregue as configurações no Squid:</b></p><p><b>{% highlight bash %}# /etc/init.d/squid3 reload{% endhighlight %}</b></p><p><b></p><p></b></p><p><div style="color: #666666;"><i><span style="font-size: x-small;"><b>Fontes:</b></span></i></div><div style="color: #666666;"><i><span style="font-size: x-small;"><b>http://pt.wikipedia.org/</b></span></i></div><div style="color: #666666;"><i><span style="font-size: x-small;"><b>http://www.hardware.com.br/</b></span></i></div><div style="color: #666666;"><i><span style="font-size: x-small;"><b>http://blog.cesar.augustus.nom.br/</b></span></i></div>

</p>
